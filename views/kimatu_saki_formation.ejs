<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>編成</title>
    <link rel="stylesheet" href="/public/rest.css">
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .card {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
        }

        .selected {
            background: #f0fff0;
        }
    </style>
</head>

<body>
    <h1>編成</h1>
    <form method="post" action="/kimatu_formation">
        <div class="grid">
            <% data.forEach(function(item, idx){ %>
                <% const checked=formation && formation.indexOf(item.id) !==-1; %>
                    <div class="card <%= checked ? 'selected' : '' %>">
                        <label>
                            <input type="checkbox" name="selected" value="<%= item.id %>" <%=checked ? 'checked' : '' %>
                            data-idx="<%= idx %>" data-status="<%= (typeof modifiedMap !=='undefined' &&
                                    modifiedMap[item.id]) ? modifiedMap[item.id] : (item.total_status || 0) %"
                                    data-type="<%= item.type %>" data-type-percent="<%= (typeof typeBonuses
                                            !=='undefined' ? (typeBonuses[item.type] || 0) : 0) %>">
                                            <strong>
                                                <%= item.name %>
                                            </strong>
                        </label>
                        <div>タイプ: <%= item.type || '-' %>
                        </div>
                        <div>レア度: <%= item.rarity || '-' %>
                        </div>
                        <div>総合(修正後): <%= (typeof modifiedMap !=='undefined' && modifiedMap[item.id]) ?
                                modifiedMap[item.id] : (item.total_status || '-' ) %>
                        </div>
                        <div><a href="/kimatu_detail/<%= item.id %>">詳細</a></div>
                    </div>
                    <% }) %>
        </div>
        <p>
            <button type="submit">編成を保存</button>
        </p>
    </form>

    <h2>合計総合力: <span id="totalSum">
            <%= typeof totalSum !=='undefined' ? totalSum : 0 %>
        </span></h2>

    <h2>現在の編成</h2>
    <% if (formation && formation.length> 0) { %>
        <ul>
            <% formation.forEach(function(id){ const c=data.find(x=> x.id === id);
                %>
                <li>
                    <%= c ? c.name : ('ID:' + id) %>
                </li>
                <% }) %>
        </ul>
        <% } else { %>
            <p>編成が選択されていません。</p>
            <% } %>
                <br>
                <a href="/kimatu_home">ホームに戻る</a>

</body>

</html>

<script>
    (function () {
        const maxSelect = 5;
        const form = document.querySelector('form[action="/kimatu_formation"]');
        const checkboxes = Array.from(form.querySelectorAll('input[type="checkbox"][name="selected"]'));
        const totalEl = document.getElementById('totalSum');
        function calcTotal() {
            const checked = checkboxes.filter(cb => cb.checked);
            let sum = checked.reduce((acc, cb) => acc + Number(cb.getAttribute('data-status') || 0), 0);
            // 同タイプ5枚編成なら全体にタイプ%を追加
            if (checked.length === maxSelect) {
                const types = checked.map(cb => cb.getAttribute('data-type'));
                const allSame = types.length === maxSelect && types.every(t => t === types[0]);
                if (allSame) {
                    const addPct = Number(checked[0].getAttribute('data-type-percent') || 0);
                    sum = Math.round(sum * (1 + addPct));
                }
            }
            return sum;
        }
        function updateChecks(e) {
            const checkedBoxes = checkboxes.filter(cb => cb.checked);
            if (checkedBoxes.length > maxSelect) {
                if (e && e.target) e.target.checked = false;
                alert('編成は最大 ' + maxSelect + ' 枚まで選べます。');
            }
            // 合計を表示
            if (totalEl) totalEl.textContent = calcTotal();
        }
        // 初期表示の合計
        if (totalEl) totalEl.textContent = calcTotal();
        checkboxes.forEach(cb => cb.addEventListener('change', updateChecks));
    })();
</script>
